{% extends 'erp/base.html' %}
{% load static %}

{% block page_title %}Project: {{ project.name }}{% endblock %}

{% block erp_content %}
<div>
    <!-- Header Section -->
    <div class="card mb-6" style="margin-bottom: 24px; border-left: 4px solid var(--primary-color);">
        <div class="flex-between">
            <div>
                <div class="flex-center gap-3 mb-2" style="justify-content: flex-start;">
                    <h2 class="text-2xl font-bold text-dark">{{ project.name }}</h2>
                    <span
                        class="badge {% if project.status == 'active' %}badge-active{% elif project.status == 'planning' %}badge-default{% else %}badge-default{% endif %}">
                        {{ project.get_status_display }}
                    </span>
                </div>
                <div class="text-sm text-gray flex-center gap-4" style="justify-content: flex-start;">
                    <span><i class="fas fa-building mr-1"></i> {{ project.client.name }}</span>
                    {% with manager_name=project.manager.username|default:"Unassigned" %}
                    <span><i class="fas fa-user-tie mr-1"></i> {{ manager_name }}</span>
                    {% endwith %}
                    {% if project.deadline %}
                    <span class="{% if project.deadline < today %}text-red{% endif %}">
                        <i class="fas fa-calendar-alt mr-1"></i> Due: {{ project.deadline }}
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="flex-center gap-3">
                <a href="{% url 'erp_project_edit' project.pk %}" class="btn-secondary">
                    <i class="fas fa-edit mr-2"></i> Edit Project
                </a>
                <a href="{% url 'erp_task_create' %}?project={{ project.pk }}" class="btn-primary">
                    <i class="fas fa-plus mr-2"></i> Add Task
                </a>
            </div>
        </div>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px;">
                <!-- Total Revenue -->
                <div style="padding-left: 0;">
                    <div class="text-gray text-xs font-bold uppercase tracking-wider mb-2">Total Revenue</div>
                    <div class="text-2xl font-bold text-dark">${{ project.revenue|floatformat:0 }}</div>
                </div>

                <!-- Budget Cost -->
                <div style="padding-left: 24px; border-left: 1px solid var(--border-color);">
                    <div class="text-gray text-xs font-bold uppercase tracking-wider mb-2">Budget Cost</div>
                    <div class="text-2xl font-bold text-dark">${{ project.budget_cost|floatformat:0 }}</div>
                </div>

                <!-- Profit Margin -->
                <div style="padding-left: 24px; border-left: 1px solid var(--border-color);">
                    <div class="text-gray text-xs font-bold uppercase tracking-wider mb-2">Profit Margin</div>
                    <div
                        class="text-2xl font-bold {% if project.profit_margin > 20 %}text-green{% else %}text-red{% endif %}">
                        {{ project.profit_margin|floatformat:1 }}%
                    </div>
                </div>

                <!-- Progress -->
                <div style="padding-left: 24px; border-left: 1px solid var(--border-color);">
                    <div class="text-gray text-xs font-bold uppercase tracking-wider mb-2">Progress</div>
                    <div class="flex-center gap-3" style="justify-content: flex-start;">
                        <div style="flex: 1; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden;">
                            <div style="width: 45%; height: 100%; background: #2563eb;"></div>
                        </div>
                        <span class="text-sm font-bold text-dark">45%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">

        <!-- Left Column: Tasks & Updates -->
        <div style="display: flex; flex-direction: column; gap: 24px;">
            <!-- Description -->
            <div class="card">
                <h3 class="text-lg font-bold text-dark mb-3">About Work</h3>
                <p class="text-gray text-sm leading-relaxed">
                    {{ project.description|default:"No description provided."|linebreaks }}
                </p>
            </div>

            <!-- Tasks Table -->
            <div class="card" style="padding: 0; overflow: hidden;">
                <div class="flex-between" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                    <h3 class="text-lg font-bold text-dark">Active Tasks</h3>
                    <a href="{% url 'erp_task_list' %}?project={{ project.pk }}"
                        class="text-sm text-blue-600 hover:underline">View All</a>
                </div>
                <table class="platform-table">
                    <thead>
                        <tr>
                            <th style="width: 45%;">Task</th>
                            <th style="width: 120px;">Who</th>
                            <th style="width: 120px;">Priority</th>
                            <th style="width: 100px;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks|slice:":5" %}
                        <tr>
                            <td class="font-bold text-dark">
                                <a href="{% url 'erp_task_detail' task.pk %}"
                                    class="hover:text-blue-600 transition-colors">
                                    {{ task.title }}
                                </a>
                            </td>
                            <td>
                                {% if task.assigned_to %}
                                <div class="flex-center gap-2" style="justify-content: flex-start;"
                                    title="{{ task.assigned_to.username }}">
                                    <div
                                        style="width: 24px; height: 24px; rounded-full; background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: #475569;">
                                        {{ task.assigned_to.username|slice:":2"|upper }}
                                    </div>
                                </div>
                                {% else %}
                                <span class="text-gray text-xs">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span
                                    class="badge {% if task.priority == 'critical' %}badge-critical{% elif task.priority == 'high' %}badge-priority-high{% else %}badge-medium{% endif %}">
                                    {{ task.priority|title }}
                                </span>
                            </td>
                            <td><span class="text-sm text-gray">{{ task.status|title }}</span></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center p-6 text-gray">No active tasks.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Right Column: Milestones & Info -->
        <div style="display: flex; flex-direction: column; gap: 24px;">

            <!-- Contract Info -->
            {% if project.contract %}
            <div class="card">
                <div class="flex-between mb-4">
                    <h3 class="text-lg font-bold text-dark">Contract</h3>
                    {% if project.contract.is_active %}
                    <span class="badge badge-active">Active</span>
                    {% else %}
                    <span class="badge badge-default">Inactive</span>
                    {% endif %}
                </div>
                <div style="font-size: 14px;">
                    <div class="mb-2"><strong>{{ project.contract.name }}</strong></div>
                    <div class="flex-center gap-2 mb-2" style="justify-content: flex-start; color: #6b7280;">
                        <i class="fas fa-calendar-alt"></i>
                        <span>{{ project.contract.start_date }} - {{ project.contract.end_date|default:"Ongoing"
                            }}</span>
                    </div>
                    <div class="flex-center gap-2 mb-4" style="justify-content: flex-start; color: #6b7280;">
                        <i class="fas fa-dollar-sign"></i>
                        <span>${{ project.contract.value }}</span>
                    </div>

                    {% if project.contract.document %}
                    <a href="{{ project.contract.document.url }}" target="_blank"
                        class="btn-secondary w-full flex-center justify-center">
                        <i class="fas fa-file-download mr-2"></i> Download Agreement
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Milestones -->
            <div class="card">
                <div class="flex-between mb-4">
                    <h3 class="text-lg font-bold text-dark">Milestones</h3>
                    <button class="text-gray hover:text-dark"
                        style="background: none; border: none; cursor: pointer;"><i class="fas fa-plus"></i></button>
                </div>
                <div style="position: relative; padding-left: 8px;">
                    <!-- Timeline Line -->
                    <div style="position: absolute; left: 8px; top: 8px; bottom: 8px; width: 2px; background: #f1f5f9;">
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 24px; margin-top: 8px;">
                        {% for milestone in milestones %}
                        <div style="position: relative; padding-left: 24px;">
                            <div
                                style="position: absolute; left: 3px; top: 6px; width: 12px; height: 12px; rounded-full; border: 2px solid white; background: {% if milestone.is_completed %}#22c55e{% else %}#cbd5e1{% endif %}; box-shadow: 0 0 0 1px #e2e8f0;">
                            </div>
                            <div style="margin-top: -4px;">
                                <h4
                                    class="text-sm font-bold text-dark {{ milestone.is_completed|yesno:'line-through text-gray,,' }}">
                                    {{ milestone.name }}
                                </h4>
                                <div class="text-xs text-gray mt-1 flex-center gap-2"
                                    style="justify-content: flex-start;">
                                    <i class="far fa-clock"></i> {{ milestone.due_date }}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray text-xs pl-2">No milestones tracked.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Team -->
            <div class="card">
                <h3 class="text-lg font-bold text-dark mb-4">Project Team</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    {% if project.manager %}
                    <div class="flex-center gap-3" style="justify-content: flex-start;">
                        <div
                            style="width: 32px; height: 32px; rounded-full; background: #e0e7ff; color: #4f46e5; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">
                            {{ project.manager.username|slice:":2"|upper }}
                        </div>
                        <div>
                            <div class="text-sm font-bold text-dark">{{ project.manager.username }}</div>
                            <div class="text-xs text-gray">Project Manager</div>
                        </div>
                    </div>
                    {% endif %}

                    {% for member in project.team.all %}
                    <div class="flex-center gap-3" style="justify-content: flex-start;">
                        <div
                            style="width: 32px; height: 32px; rounded-full; background: #f1f5f9; color: #475569; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">
                            {{ member.username|slice:":2"|upper }}
                        </div>
                        <div>
                            <div class="text-sm font-bold text-dark">{{ member.username }}</div>
                            <div class="text-xs text-gray">Team Member</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block header %}{% endblock %}
{% block footer %}{% endblock %}

{% block content %}
<!-- CSS -->
<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@400;500;600;700&display=swap"
    rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'platform/css/platform.css' %}?v=3004">
<link rel="stylesheet" href="{% static 'erp/css/erp.css' %}?v=9">

<script>
    if (localStorage.getItem('sidebar-collapsed') === 'true') {
        document.body.classList.add('sidebar-collapsed');
    }
    (function () {
        const savedTheme = localStorage.theme || 'system';
        if (savedTheme === 'dark' || (savedTheme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    })();
</script>

<div class="dashboard-container" id="dashboard-container">
    <!-- Sidebar -->
    <aside class="dashboard-sidebar">
        <div class="sidebar-brand">
            <a href="{% url 'erp_overview' %}"
                style="display: flex; align-items: center; gap: 12px; color: inherit; text-decoration: none;">
                <img src="{% static 'base/assets/logo/logo.png' %}" alt="BitGuard Logo"
                    style="height: 30px; filter: brightness(0) invert(1);">
                <span
                    style="color: white; font-size: 24px; font-weight: 600; font-family: 'Oswald'; letter-spacing: 2px; transform: scaleY(1.4); display: inline-block; margin-top: -4px;">BITGUARD</span>
            </a>
        </div>

        <nav class="sidebar-nav" style="flex: 1;">
            <ul>
                <!-- Dashboard -->
                <li class="mb-1">
                    <a href="{% url 'erp_overview' %}"
                        class="px-4 py-2.5 flex items-center gap-3 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg transition-all {% if request.resolver_match.url_name == 'erp_overview' %}bg-indigo-600 text-white shadow-lg shadow-indigo-500/30{% endif %}">
                        <i class="fas fa-tachometer-alt w-5 text-center"></i>
                        <span class="font-medium">Dashboard</span>
                    </a>
                </li>

                <!-- Delivery & Engineering -->
                <li class="sidebar-group-label"
                    style="padding: 20px 20px 10px; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">
                    Delivery & Engineering
                </li>
                <li>
                    <a href="{% url 'erp_project_list' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'project' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-project-diagram w-5 text-center"></i>
                        <span>Projects</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_service_list' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'service' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-concierge-bell w-5 text-center"></i>
                        <span>Services</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_task_list' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'task' in request.resolver_match.url_name and 'timelog' not in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-check-square w-5 text-center"></i>
                        <span>Tasks</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_timelog_list' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'timelog' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-clock w-5 text-center"></i>
                        <span>Time Logs</span>
                    </a>
                </li>

                <!-- People -->
                <li class="sidebar-group-label"
                    style="padding: 20px 20px 10px; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">
                    People
                </li>
                <li>
                    <a href="{% url 'erp_workforce_list' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'workforce' in request.resolver_match.url_name or 'employee' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-users w-5 text-center"></i>
                        <span>Workforce</span>
                    </a>
                </li>

                <!-- IT & Procurement -->
                <li class="sidebar-group-label"
                    style="padding: 20px 20px 10px; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">
                    IT & Procurement
                </li>
                <li>
                    <a href="{% url 'erp_asset_list' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'asset' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-laptop w-5 text-center"></i>
                        <span>Assets</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_vendor_list' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'vendor' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-building w-5 text-center"></i>
                        <span>Vendors</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_contract_list' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'contract' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-file-signature w-5 text-center"></i>
                        <span>Contracts</span>
                    </a>
                </li>

                <!-- Finance -->
                <li class="sidebar-group-label"
                    style="padding: 20px 20px 10px; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">
                    Finance
                </li>
                <li>
                    <a href="{% url 'erp_financial_overview' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'financial_overview' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-chart-pie w-5 text-center"></i>
                        <span>Overview</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_invoice_list' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'invoice' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-file-invoice-dollar w-5 text-center"></i>
                        <span>Invoices</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_bill_list' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'bill' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-file-invoice w-5 text-center"></i>
                        <span>Vendor Bills</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_expense_list' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'expense' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-receipt w-5 text-center"></i>
                        <span>Expenses</span>
                    </a>
                </li>

                <!-- Legal & GRC -->
                <li class="sidebar-group-label"
                    style="padding: 20px 20px 10px; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">
                    Legal & GRC
                </li>
                <li>
                    <a href="{% url 'erp_compliance_dashboard' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'compliance' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-shield-alt w-5 text-center"></i>
                        <span>Compliance Hub</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_policy_list' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'policy' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-book w-5 text-center"></i>
                        <span>Policies</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_risk_runbook' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'risk' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-exclamation-triangle w-5 text-center"></i>
                        <span>Risk Register</span>
                    </a>
                </li>

                <!-- Analytics -->
                <li class="sidebar-group-label"
                    style="padding: 20px 20px 10px; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">
                    Analytics
                </li>
                <li>
                    <a href="{% url 'erp_financial_report' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'financial_report' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-chart-bar w-5 text-center"></i>
                        <span>Financial</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_operations_report' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'operations_report' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-chart-line w-5 text-center"></i>
                        <span>Operations</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_security_report' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'security_report' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-user-shield w-5 text-center"></i>
                        <span>SecOps</span>
                    </a>
                </li>

                <!-- Platform -->
                <li class="sidebar-group-label"
                    style="padding: 20px 20px 10px; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">
                    Platform
                </li>
                <li>
                    <a href="{% url 'erp_system_dashboard' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'system_dashboard' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-server w-5 text-center"></i>
                        <span>System Status</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_integrations' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'integrations' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-plug w-5 text-center"></i>
                        <span>Integrations</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'erp_audit_logs' %}"
                        class="px-4 py-2 flex items-center gap-3 text-gray-400 hover:text-white rounded-lg transition-colors {% if 'audit' in request.resolver_match.url_name %}text-white bg-gray-800{% endif %}">
                        <i class="fas fa-history w-5 text-center"></i>
                        <span>Audit Logs</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer" style="margin-top: auto; padding: 0;">
            <ul style="list-style: none; padding: 0; margin: 0;">
                <li>
                    <a href="{% url 'dashboard_home' %}" class="dashboard-sidebar-link">
                        <i class="fas fa-arrow-left"></i>
                        <span>Exit Console</span>
                    </a>
                </li>
            </ul>

            <!-- Sidebar Footer (User Profile) -->
            <div class="user-profile-container">
                <div id="sidebarUserMenu" onclick="toggleSidebarUserMenu(event)">

                    <!-- Avatar -->
                    <div class="user-avatar-wrapper"
                        style="width: 38px; height: 38px; background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 14px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); border: 2px solid rgba(255, 255, 255, 0.1); overflow: hidden;">
                        {% if request.user.profile.photo %}
                        <img src="{{ request.user.profile.photo.url }}" alt="Profile"
                            style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                        {{ request.user.username|slice:":2"|upper }}
                        {% endif %}
                    </div>

                    <!-- Name & Role -->
                    <div class="user-info-wrapper" style="flex: 1; overflow: hidden;">
                        <div class="user-name-display"
                            style="color: white; font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ request.user.username }}</div>
                        <div class="user-profile-link" style="color: rgba(255, 255, 255, 0.5); font-size: 11px;">View
                            Profile</div>
                    </div>

                    <!-- Chevron -->
                    <i class="fas fa-chevron-up chevron-icon"
                        style="color: rgba(255, 255, 255, 0.5); font-size: 12px;"></i>
                </div>

                <!-- Canva-Style Popover Menu -->
                <div id="sidebarUserDropup" class="canva-menu">

                    <!-- Section 1: Profile -->
                    <div class="canva-section">
                        <div class="canva-header-label">Accounts</div>
                        <div class="canva-profile-item" style="cursor: pointer; position: relative;"
                            onclick="toggleNestedMenu('accountsNestedMenu', event)">
                            <div class="canva-avatar-large">
                                {% if request.user.profile.photo %}
                                <img src="{{ request.user.profile.photo.url }}" alt="Profile"
                                    style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                {% else %}
                                {{ request.user.username|slice:":2"|upper }}
                                {% endif %}
                            </div>
                            <div class="canva-user-info">
                                <div class="canva-user-name">{{ request.user.username }}</div>
                                <div class="canva-user-email">{{ request.user.email }}</div>
                            </div>
                            <i class="fas fa-chevron-right" style="font-size: 12px; color: #cbd5e1;"></i>

                            <!-- Nested Accounts Menu -->
                            <div id="accountsNestedMenu" class="canva-nested-menu nested-menu-wide">
                                <div class="nested-menu-header"
                                    style="padding: 8px 12px; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase;">
                                    Switch accounts</div>

                                <!-- Current Account -->
                                <div class="canva-nested-item active"
                                    style="padding: 10px 12px; display: flex; align-items: center; justify-content: space-between; border-radius: 8px; background: #f1f5f9; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div
                                            style="width: 32px; height: 32px; background: #cbd5e1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #475569; font-size: 12px;">
                                            {{ request.user.username|slice:":2"|upper }}
                                        </div>
                                        <div>
                                            <div style="font-size: 13px; font-weight: 600; color: #1e293b;">{{
                                                request.user.username }}</div>
                                            <div style="font-size: 11px; color: #64748b;">{{ request.user.email }}</div>
                                        </div>
                                    </div>
                                    <i class="fas fa-check" style="color: #0ea5e9; font-size: 12px;"></i>
                                </div>

                                <div style="height: 1px; background: #e2e8f0; margin: 4px 0;"></div>

                                <!-- Options -->
                                <div class="canva-nested-item"
                                    style="padding: 8px 12px; display: flex; align-items: center; gap: 10px; font-size: 13px; color: #334155; border-radius: 6px; cursor: pointer;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-plus" style="width: 16px; text-align: center;"></i> Add another
                                        account
                                    </div>
                                </div>
                                <div class="canva-nested-item"
                                    style="padding: 8px 12px; display: flex; align-items: center; gap: 10px; font-size: 13px; color: #334155; border-radius: 6px; cursor: pointer;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-user-cog" style="width: 16px; text-align: center;"></i> Manage
                                        accounts
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Actions -->
                    <div class="canva-section">
                        <a href="{% url 'account_dashboard' %}" class="canva-menu-item">
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-cog"></i> Settings
                            </div>
                        </a>

                        <div class="canva-menu-item" style="cursor: pointer; position: relative;"
                            onclick="toggleNestedMenu('themeNestedMenu', event)">
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-moon"></i> Theme
                            </div>
                            <i class="fas fa-chevron-right arrow" style="font-size: 10px;"></i>

                            <!-- Nested Menu -->
                            <div id="themeNestedMenu" class="canva-nested-menu">
                                <div class="canva-nested-item" data-theme="light" onclick="setTheme('light', event)"
                                    style="padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-sun" style="width: 16px;"></i> Light
                                    </div>
                                    <i class="fas fa-check check-icon" style="color: #0ea5e9; display: none;"></i>
                                </div>
                                <div class="canva-nested-item" data-theme="dark" onclick="setTheme('dark', event)"
                                    style="padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-moon" style="width: 16px;"></i> Dark
                                    </div>
                                    <i class="fas fa-check check-icon" style="color: #0ea5e9; display: none;"></i>
                                </div>
                                <div class="canva-nested-item" data-theme="system" onclick="setTheme('system', event)"
                                    style="padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-desktop" style="width: 16px;"></i> Sync with system
                                    </div>
                                    <i class="fas fa-check check-icon" style="color: #0ea5e9; display: none;"></i>
                                </div>
                            </div>
                        </div>

                        <a href="{% url 'client_portal' %}" class="canva-menu-item">
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-users-cog"></i> Client Portal
                            </div>
                        </a>

                        <a href="{% url 'plans_page' %}" class="canva-menu-item">
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-briefcase"></i> Plans and pricing
                            </div>
                        </a>

                        <a href="{% url 'my_subscriptions' %}" class="canva-menu-item">
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-shopping-cart"></i> Purchase history
                            </div>
                        </a>

                        {% if request.user.is_staff %}
                        <a href="/admin/" target="_blank" class="canva-menu-item">
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-shield-alt"></i> Admin Panel
                            </div>
                            <i class="fas fa-external-link-alt arrow" style="font-size: 10px;"></i>
                        </a>
                        {% endif %}
                    </div>

                    <!-- Section 3: Logout -->
                    <div class="canva-section">
                        <a href="{% url 'logout' %}" class="canva-menu-item logout">
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-sign-out-alt"></i> Log out
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <script>
                function toggleSidebarUserMenu(e) {
                    e.stopPropagation();
                    const menu = document.getElementById('sidebarUserDropup');
                    const trigger = document.getElementById('sidebarUserMenu');

                    if (menu.style.display === 'block') {
                        menu.style.display = 'none';
                        return;
                    }

                    closeNestedMenus();

                    const rect = trigger.getBoundingClientRect();
                    const isCollapsed = document.body.classList.contains('sidebar-collapsed');

                    menu.style.display = 'block';
                    menu.style.position = 'fixed';
                    menu.style.zIndex = '10000';

                    menu.style.top = 'auto';
                    menu.style.right = 'auto';

                    if (isCollapsed) {
                        menu.style.left = (rect.right + 10) + 'px';
                        menu.style.bottom = (window.innerHeight - rect.bottom) + 'px';
                    } else {
                        menu.style.left = (rect.left + 10) + 'px';
                        menu.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
                    }
                }

                document.addEventListener('click', function (e) {
                    const menu = document.getElementById('sidebarUserDropup');
                    if (menu && menu.style.display === 'block' && !menu.contains(e.target)) {
                        menu.style.display = 'none';
                    }
                });
            </script>
        </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="dashboard-main-wrapper">
        <!-- Dashboard Header -->
        <header class="dashboard-header">
            <!-- Sidebar Toggle Button -->
            <button id="sidebarToggle" onclick="toggleSidebar()"
                style="border: none; background: transparent; color: var(--text-secondary); cursor: pointer; padding: 8px; margin-right: 15px; border-radius: 8px; transition: background 0.2s;">
                <i class="fas fa-bars" style="font-size: 20px;"></i>
            </button>

            <div class="header-platform-label"
                style="margin-right: auto; font-family: 'Oswald', sans-serif; font-size: 20px; font-weight: 500; color: var(--text-primary); letter-spacing: 0.5px; text-transform: uppercase;">
                ERP Console
            </div>

            <div class="header-right" style="display: flex; align-items: center; gap: 15px;">
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()" class="theme-toggle"
                    style="background: transparent; border: 1px solid #e5e7eb; padding: 6px 10px; border-radius: 8px; cursor: pointer; color: #64748b;">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>

                <div class="header-highlight-btn"
                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);">
                    <i class="fas fa-shield-alt"></i> INTERNAL
                </div>
            </div>
        </header>

        <script>
            // Theme Logic
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');

            const savedTheme = localStorage.theme || 'system';
            updateThemeChecks(savedTheme);

            function applyTheme(theme) {
                if (theme === 'dark') {
                    html.classList.add('dark');
                    if (themeIcon) { themeIcon.classList.remove('fa-moon'); themeIcon.classList.add('fa-sun'); }
                } else if (theme === 'light') {
                    html.classList.remove('dark');
                    if (themeIcon) { themeIcon.classList.remove('fa-sun'); themeIcon.classList.add('fa-moon'); }
                } else {
                    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        html.classList.add('dark');
                        if (themeIcon) { themeIcon.classList.remove('fa-moon'); themeIcon.classList.add('fa-sun'); }
                    } else {
                        html.classList.remove('dark');
                        if (themeIcon) { themeIcon.classList.remove('fa-sun'); themeIcon.classList.add('fa-moon'); }
                    }
                }
                updateThemeChecks(theme);
            }

            function updateThemeChecks(activeTheme) {
                document.querySelectorAll('.canva-nested-item').forEach(item => {
                    const check = item.querySelector('.check-icon');
                    if (check) check.style.display = 'none';
                    if (item.dataset.theme === activeTheme && check) check.style.display = 'block';
                });
            }

            function setTheme(theme, e) {
                if (e) e.stopPropagation();
                localStorage.theme = theme;
                applyTheme(theme);
            }

            function toggleTheme() {
                const current = localStorage.theme === 'dark' ? 'dark' : 'light';
                const newTheme = current === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
            }

            function toggleSidebar() {
                document.body.classList.toggle('sidebar-collapsed');
                const isCollapsed = document.body.classList.contains('sidebar-collapsed');
                localStorage.setItem('sidebar-collapsed', isCollapsed);
            }
            window.toggleSidebar = toggleSidebar;

            function toggleNestedMenu(menuId, e) {
                if (e) e.stopPropagation();

                document.querySelectorAll('.canva-nested-menu').forEach(m => {
                    if (m.id !== menuId) m.style.display = 'none';
                });

                const menu = document.getElementById(menuId);
                const trigger = e.currentTarget;

                if (menu.style.display === 'block') {
                    menu.style.display = 'none';
                } else {
                    if (menuId === 'themeNestedMenu') {
                        updateThemeChecks(localStorage.theme || 'system');
                    }

                    const rect = trigger.getBoundingClientRect();

                    menu.style.visibility = 'hidden';
                    menu.style.display = 'block';
                    menu.style.position = 'fixed';
                    menu.style.left = (rect.right + 10) + 'px';
                    menu.style.top = rect.top + 'px';
                    menu.style.zIndex = '9999';
                    menu.style.visibility = 'visible';

                    const menuRect = menu.getBoundingClientRect();
                    if (menuRect.bottom > window.innerHeight) {
                        menu.style.top = (window.innerHeight - menuRect.height - 20) + 'px';
                    }
                }
            }

            function closeNestedMenus() {
                document.querySelectorAll('.canva-nested-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
            }

            document.addEventListener('click', closeNestedMenus);
            window.addEventListener('scroll', closeNestedMenus, true);
            window.addEventListener('resize', closeNestedMenus, true);
        </script>

        <!-- Main Content Area -->
        <main class="dashboard-content">
            {% block erp_content %}
            {% endblock %}
        </main>
    </div>
</div>

<script>
    function forceDashboardHeight() {
        const container = document.getElementById('dashboard-container');
        if (container) {
            container.style.minHeight = window.innerHeight + 'px';
        }
    }
    window.addEventListener('load', forceDashboardHeight);
    window.addEventListener('resize', forceDashboardHeight);
    forceDashboardHeight();
</script>
{% endblock %}
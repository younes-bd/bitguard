{% extends 'crm/base_crm.html' %}
{% load static %}

{% block dashboard_content %}
<div style="margin-bottom: 20px;">
    <a href="{% url 'crm_clients' %}"
        style="color: #6b7280; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; gap: 5px;">
        <i class="fas fa-arrow-left"></i> Back to Clients
    </a>
</div>

<div class="flex-between mb-4">
    <div style="display: flex; align-items: center; gap: 15px;">
        <div
            style="width: 48px; height: 48px; background-color: #0ea5e9; color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold;">
            {{ client.name|slice:":1" }}
        </div>
        <div>
            <h1 class="text-2xl" style="margin-bottom: 4px;">{{ client.name }}</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span class="badge" style="background-color: #f3f4f6;">{{ client.get_client_type_display }}</span>
                {% if client.company_name %}
                <span style="color: #6b7280; font-size: 13px;"><i class="fas fa-building"></i> {{ client.company_name
                    }}</span>
                {% endif %}
            </div>
        </div>
    </div>

    <div style="display: flex; gap: 10px;">
        <a href="{% url 'admin:crm_client_change' client.id %}" target="_blank"
            style="background-color: white; border: 1px solid #e5e7eb; color: #374151; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 13px;">
            <i class="fas fa-edit"></i> Edit
        </a>
        <button
            style="background-color: #0ea5e9; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer;">
            <i class="fas fa-envelope"></i> Email Logic
        </button>
    </div>
</div>

<div class="grid-cols-3">
    <!-- Left Column: Details -->
    <div class="card">
        <h3 class="text-lg mb-4">Client Details</h3>

        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div>
                <label
                    style="display: block; font-size: 11px; text-transform: uppercase; color: #9ca3af; font-weight: 600; margin-bottom: 4px;">Status</label>
                <span class="badge {% if client.status == 'active' %}badge-low{% else %}badge-medium{% endif %}">{{
                    client.get_status_display }}</span>
            </div>

            <div>
                <label
                    style="display: block; font-size: 11px; text-transform: uppercase; color: #9ca3af; font-weight: 600; margin-bottom: 4px;">SLA
                    Level</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-shield-alt" style="color: #d97706;"></i>
                    <span style="font-weight: 500;">{{ client.get_sla_level_display }}</span>
                </div>
            </div>

            <div>
                <label
                    style="display: block; font-size: 11px; text-transform: uppercase; color: #9ca3af; font-weight: 600; margin-bottom: 4px;">Contact
                    Info</label>
                {% if client.phone %}
                <div style="margin-bottom: 4px;"><i class="fas fa-phone" style="width: 20px; color: #9ca3af;"></i> {{
                    client.phone }}</div>
                {% endif %}
                {% if client.website %}
                <div style="margin-bottom: 4px;"><a href="{{ client.website }}" target="_blank"
                        style="color: #0ea5e9; text-decoration: none;"><i class="fas fa-globe"
                            style="width: 20px; color: #9ca3af;"></i> Website</a></div>
                {% endif %}
                {% if client.address %}
                <div style="color: #6b7280; font-size: 13px; margin-top: 4px;">{{ client.address }}</div>
                {% endif %}
            </div>

            <div>
                <label
                    style="display: block; font-size: 11px; text-transform: uppercase; color: #9ca3af; font-weight: 600; margin-bottom: 4px;">Account
                    Manager</label>
                {% if client.account_manager %}
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div
                        style="width: 24px; height: 24px; background-color: #a5b4fc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white;">
                        {{ client.account_manager.username|slice:":1"|upper }}
                    </div>
                    <span>{{ client.account_manager.first_name }} {{ client.account_manager.last_name }}</span>
                </div>
                {% else %}
                <span style="color: #9ca3af; font-style: italic;">Unassigned</span>
                {% endif %}
            </div>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #f3f4f6;">

        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">Primary Contacts</h4>
        {% for contact in contacts %}
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <div
                style="width: 32px; height: 32px; background-color: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #6b7280;">
                <i class="fas fa-user"></i>
            </div>
            <div>
                <div style="font-size: 13px; font-weight: 600;">{{ contact.first_name }} {{ contact.last_name }}</div>
                <div style="font-size: 11px; color: #6b7280;">{{ contact.email }}</div>
            </div>
        </div>
        {% empty %}
        <p style="font-size: 13px; color: #9ca3af;">No contacts listed.</p>
        {% endfor %}
    </div>

    <!-- Right Column: Tickets & Projects -->
    <div class="col-span-2">
        <!-- Tickets -->
        <div class="card">
            <div class="flex-between mb-4">
                <h3 class="text-lg">Support Tickets</h3>
                <a href="#" style="font-size: 13px; color: #0ea5e9; text-decoration: none;">View All</a>
            </div>

            <table class="platform-table">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Created</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for ticket in tickets|slice:":5" %}
                    <tr>
                        <td>
                            <div style="font-weight: 600;">{{ ticket.summary }}</div>
                            <div style="font-size: 11px; color: #6b7280;">#{{ ticket.id }}</div>
                        </td>
                        <td>
                            <span
                                class="badge {% if ticket.status == 'active' %}badge-low{% else %}badge-medium{% endif %}">
                                {{ ticket.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <span style="font-size: 12px; font-weight: 600;
                            {% if ticket.priority == 'critical' %}color: #ef4444;
                            {% elif ticket.priority == 'high' %}color: #f97316;
                            {% else %}color: #6b7280;{% endif %}">
                                {{ ticket.get_priority_display }}
                            </span>
                        </td>
                        <td>{{ ticket.created_at|timesince }} ago</td>
                        <td>
                            <a href="{% url 'crm_ticket_detail' ticket.id %}" style="color: #0ea5e9;">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center; color: #9ca3af; padding: 20px;">No tickets found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Projects -->
        <div class="card">
            <div class="flex-between mb-4">
                <h3 class="text-lg">Projects</h3>
                <a href="#" style="font-size: 13px; color: #0ea5e9; text-decoration: none;">View All</a>
            </div>

            <div style="display: flex; flex-direction: column; gap: 15px;">
                {% for project in projects %}
                <div style="border: 1px solid #f3f4f6; border-radius: 12px; padding: 15px;">
                    <div class="flex-between mb-2">
                        <div style="font-weight: 600;">{{ project.name }}</div>
                        <span class="badge">{{ project.get_status_display }}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div
                            style="flex: 1; height: 6px; background-color: #f3f4f6; border-radius: 3px; overflow: hidden;">
                            <div style="width: {{ project.progress }}%; height: 100%; background-color: #0ea5e9;"></div>
                        </div>
                        <span style="font-size: 12px; font-weight: 600; color: #6b7280;">{{ project.progress }}%</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                        Due: {{ project.end_date|default:"TBD" }}
                    </div>
                </div>
                {% empty %}
                <p style="text-align: center; color: #9ca3af; padding: 20px;">No projects active.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Contracts Section -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="flex-between mb-4">
                <h3 class="text-lg">Contracts</h3>
                <a href="{% url 'crm_contract_create' client.id %}"
                    style="font-size: 13px; color: #0ea5e9; text-decoration: none; font-weight: 600;">
                    <i class="fas fa-plus"></i> Add Contract
                </a>
            </div>

            {% if contracts %}
            <div style="display: flex; flex-direction: column; gap: 15px;">
                {% for contract in contracts %}
                <div
                    style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: {% if not contract.is_active %}#f9fafb{% else %}white{% endif %};">
                    <div class="flex-between">
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <div
                                style="width: 40px; height: 40px; background: #eff6ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #2563eb;">
                                <i class="fas fa-file-contract"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #111827;">{{ contract.name }}</div>
                                <div style="font-size: 12px; color: #6b7280;">
                                    {{ contract.start_date }} - {{ contract.end_date|default:"Ongoing" }}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #111827;">${{ contract.value }}</div>
                            <div style="font-size: 11px;">
                                {% if contract.is_active %}
                                <span style="color: #059669; font-weight: 500;">Active</span>
                                {% else %}
                                <span style="color: #9ca3af;">Inactive</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% if contract.document %}
                    <div
                        style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f3f4f6; font-size: 13px; display: flex; justify-content: space-between; align-items: center;">
                        <a href="{{ contract.document.url }}" target="_blank"
                            style="color: #4b5563; text-decoration: none; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-paperclip"></i> View Document
                        </a>
                        <a href="{% url 'erp_invoice_create' %}?client={{ client.pk }}&contract={{ contract.pk }}"
                            style="color: #7e22ce; text-decoration: none; font-weight: 600; font-size: 13px;">
                            <i class="fas fa-file-invoice-dollar mr-1"></i> Bill Contract
                        </a>
                    </div>
                    {% else %}
                    <div
                        style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f3f4f6; font-size: 13px; text-align: right;">
                        <a href="{% url 'erp_invoice_create' %}?client={{ client.pk }}&contract={{ contract.pk }}"
                            style="color: #7e22ce; text-decoration: none; font-weight: 600; font-size: 13px;">
                            <i class="fas fa-file-invoice-dollar mr-1"></i> Bill Contract
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div
                style="text-align: center; padding: 32px; background: #f9fafb; border-radius: 12px; border: 1px dashed #d1d5db;">
                <p style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">No contracts on file.</p>
                <a href="{% url 'crm_contract_create' client.id %}"
                    style="color: #0ea5e9; font-size: 13px; font-weight: 500; text-decoration: none;">Upload one now</a>
            </div>
            {% endif %}
        </div>

        <!-- Store Integration -->
        <div class="card">
            <h3 class="text-lg mb-4">Store & Products</h3>

            <!-- Subscriptions -->
            <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 10px;">Subscriptions</h4>
            {% if subscriptions %}
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                {% for sub in subscriptions %}
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <div style="font-weight: bold; color: #0f172a;">{{ sub.plan.name }}</div>
                    <div class="flex-between mt-2">
                        <span class="badge {% if sub.status == 'active' %}badge-low{% else %}badge-medium{% endif %}">{{
                            sub.get_status_display }}</span>
                        <span style="font-size: 12px; color: #64748b;">{{ sub.plan.price_monthly }}/mo</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="font-size: 13px; color: #9ca3af; margin-bottom: 20px;">No active subscriptions.</p>
            {% endif %}

            <!-- Recent Orders -->
            <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 10px;">Recent Orders</h4>
            <div style="overflow-x: auto;">
                <table class="platform-table">
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Product</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders|slice:":5" %}
                        <tr>
                            <td>#{{ order.id }}</td>
                            <td>{{ order.product.name|default:"General Item" }}</td>
                            <td>${{ order.amount }}</td>
                            <td>
                                <span class="badge" style="background-color: #f3f4f6;">{{ order.status|title }}</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #9ca3af;">No orders found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}